<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Zombie Shooter</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: sans-serif;
      font-size: 18px;
      z-index: 10;
    }
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 24px;
      z-index: 10;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div id="hud">Health: 100<br>Score: 0</div>
<button id="startButton">Click to Start</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/PointerLockControls.js"></script>
<script>
let scene, camera, renderer, controls;
let bullets = [], zombies = [], gun;
let health = 100, score = 0;
let move = { forward: false, backward: false, left: false, right: false };
let clock = new THREE.Clock();
let hud = document.getElementById('hud');

document.getElementById('startButton').onclick = () => {
  document.getElementById('startButton').style.display = 'none';
  init();
  animate();
};

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x202020);

  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  controls = new THREE.PointerLockControls(camera, document.body);
  document.body.addEventListener('click', () => controls.lock());
  scene.add(controls.getObject());

  // Load working gun model (GLB file hosted on Poly Pizza)
  const loader = new THREE.GLTFLoader();
  loader.load('https://cdn.glitch.global/72a8b393-3810-4db5-b3c2-fc72a18dcaa2/lowpoly_gun.glb?v=1714672533414', gltf => {
    gun = gltf.scene;
    gun.scale.set(0.2, 0.2, 0.2);
    gun.position.set(0.4, -0.5, -1);
    camera.add(gun);
  });

  // Ground
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(200, 200),
    new THREE.MeshStandardMaterial({ color: 0x303030 })
  );
  floor.rotation.x = -Math.PI / 2;
  scene.add(floor);

  // Light
  const light = new THREE.HemisphereLight(0xffffff, 0x333333);
  light.position.set(0, 200, 0);
  scene.add(light);

  // Movement
  document.addEventListener('keydown', e => {
    if (e.code === 'KeyW') move.forward = true;
    if (e.code === 'KeyS') move.backward = true;
    if (e.code === 'KeyA') move.left = true;
    if (e.code === 'KeyD') move.right = true;
  });
  document.addEventListener('keyup', e => {
    if (e.code === 'KeyW') move.forward = false;
    if (e.code === 'KeyS') move.backward = false;
    if (e.code === 'KeyA') move.left = false;
    if (e.code === 'KeyD') move.right = false;
  });

  document.addEventListener('click', shoot);

  // Spawn zombies
  spawnZombie();
  setInterval(spawnZombie, 3000);
}

function shoot() {
  const bullet = new THREE.Mesh(
    new THREE.SphereGeometry(0.1, 8, 8),
    new THREE.MeshBasicMaterial({ color: 0xffff00 })
  );
  bullet.position.copy(camera.position);
  bullet.direction = camera.getWorldDirection(new THREE.Vector3()).clone();
  bullet.spawnTime = clock.elapsedTime;
  bullets.push(bullet);
  scene.add(bullet);
}

function spawnZombie() {
  const zombie = new THREE.Mesh(
    new THREE.BoxGeometry(1, 2, 1),
    new THREE.MeshBasicMaterial({ color: 0x00ff00 })
  );
  const angle = Math.random() * Math.PI * 2;
  const radius = 30 + Math.random() * 10;
  zombie.position.set(Math.cos(angle) * radius, 1, Math.sin(angle) * radius);
  zombies.push(zombie);
  scene.add(zombie);
}

function animate() {
  requestAnimationFrame(animate);
  const delta = clock.getDelta();
  const speed = 5 * delta;

  // Movement
  const direction = new THREE.Vector3();
  if (move.forward) direction.z -= 1;
  if (move.backward) direction.z += 1;
  if (move.left) direction.x -= 1;
  if (move.right) direction.x += 1;
  direction.normalize();
  controls.moveRight(direction.x * speed);
  controls.moveForward(direction.z * speed);

  // Bullets
  bullets.forEach((bullet, i) => {
    bullet.position.add(bullet.direction.clone().multiplyScalar(30 * delta));
    if (clock.elapsedTime - bullet.spawnTime > 2) {
      scene.remove(bullet);
      bullets.splice(i, 1);
    }
  });

  // Zombie AI + Collision
  zombies.forEach((zombie, i) => {
    const dir = new THREE.Vector3().subVectors(camera.position, zombie.position).normalize();
    zombie.position.add(dir.multiplyScalar(1.5 * delta));
    if (zombie.position.distanceTo(camera.position) < 1.3) {
      health -= 15 * delta;
      if (health <= 0) {
        alert("Game Over! Final Score: " + score);
        location.reload();
      }
    }
  });

  // Bullet hits
  bullets.forEach((bullet, bi) => {
    zombies.forEach((zombie, zi) => {
      if (bullet.position.distanceTo(zombie.position) < 1) {
        scene.remove(bullet);
        scene.remove(zombie);
        bullets.splice(bi, 1);
        zombies.splice(zi, 1);
        score += 10;
      }
    });
  });

  hud.innerHTML = `Health: ${Math.floor(health)}<br>Score: ${score}`;
  renderer.render(scene, camera);
}
</script>
</body>
</html>
