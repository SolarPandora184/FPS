<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Zombie Shooter with Gun Model</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #hud {
      position: absolute;
      color: white;
      top: 10px;
      left: 10px;
      font-family: sans-serif;
      font-size: 18px;
      z-index: 10;
    }
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>
<div id="hud">Health: 100<br>Score: 0</div>
<button id="startButton">Click to Start</button>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/PointerLockControls.js"></script>
<script>
  let scene, camera, renderer, controls;
  let bullets = [], zombies = [], gun;
  let health = 100, score = 0;
  let clock = new THREE.Clock();
  let hud = document.getElementById('hud');
  let move = { forward: false, backward: false, left: false, right: false };

  document.getElementById('startButton').onclick = () => {
    document.getElementById('startButton').style.display = 'none';
    init();
    animate();
  };

  function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x202020);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    controls = new THREE.PointerLockControls(camera, document.body);
    document.body.addEventListener('click', () => controls.lock());
    scene.add(controls.getObject());

    // Load gun model
    const loader = new THREE.GLTFLoader();
    loader.load('https://models.readyplayer.me/642c291be1277d001e6f010b.glb', gltf => {
      gun = gltf.scene;
      gun.scale.set(0.5, 0.5, 0.5);
      gun.position.set(0.4, -0.4, -1); // Position in front of camera
      gun.rotation.y = Math.PI; // Flip if needed
      camera.add(gun); // Attach to camera
    });

    // Floor
    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(100, 100),
      new THREE.MeshStandardMaterial({ color: 0x303030 })
    );
    floor.rotation.x = -Math.PI / 2;
    scene.add(floor);

    // Light
    const light = new THREE.HemisphereLight(0xffffff, 0x444444);
    light.position.set(0, 200, 0);
    scene.add(light);

    // Movement
    document.addEventListener('keydown', e => {
      if (e.code === 'KeyW') move.forward = true;
      if (e.code === 'KeyS') move.backward = true;
      if (e.code === 'KeyA') move.left = true;
      if (e.code === 'KeyD') move.right = true;
    });
    document.addEventListener('keyup', e => {
      if (e.code === 'KeyW') move.forward = false;
      if (e.code === 'KeyS') move.backward = false;
      if (e.code === 'KeyA') move.left = false;
      if (e.code === 'KeyD') move.right = false;
    });

    document.addEventListener('click', shoot);

    spawnZombie();
    setInterval(spawnZombie, 2000);
  }

  function shoot() {
    const bullet = new THREE.Mesh(
      new THREE.SphereGeometry(0.1, 8, 8),
      new THREE.MeshBasicMaterial({ color: 0xffff00 })
    );
    bullet.position.copy(camera.position);
    bullet.direction = camera.getWorldDirection(new THREE.Vector3()).clone();
    bullet.spawnTime = clock.elapsedTime;
    bullets.push(bullet);
    scene.add(bullet);
  }

  function spawnZombie() {
    const zombie = new THREE.Mesh(
      new THREE.BoxGeometry(1, 2, 1),
      new THREE.MeshBasicMaterial({ color: 0x00ff00 })
    );
    const angle = Math.random() * Math.PI * 2;
    const radius = 30 + Math.random() * 20;
    zombie.position.set(Math.cos(angle) * radius, 1, Math.sin(angle) * radius);
    zombies.push(zombie);
    scene.add(zombie);
  }

  function animate() {
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    const speed = 5 * delta;

    // Movement
    const dir = new THREE.Vector3();
    if (move.forward) dir.z -= 1;
    if (move.backward) dir.z += 1;
    if (move.left) dir.x -= 1;
    if (move.right) dir.x += 1;
    dir.normalize();
    controls.moveRight(dir.x * speed);
    controls.moveForward(dir.z * speed);

    // Bullets
    bullets.forEach((bullet, i) => {
      bullet.position.add(bullet.direction.clone().multiplyScalar(20 * delta));
      if (clock.elapsedTime - bullet.spawnTime > 2) {
        scene.remove(bullet);
        bullets.splice(i, 1);
      }
    });

    // Bullet-Zombie collisions
    bullets.forEach((bullet, i) => {
      zombies.forEach((zombie, j) => {
        if (bullet.position.distanceTo(zombie.position) < 1) {
          scene.remove(bullet);
          scene.remove(zombie);
          bullets.splice(i, 1);
          zombies.splice(j, 1);
          score += 10;
        }
      });
    });

    // Zombies chase player
    zombies.forEach(zombie => {
      const dir = new THREE.Vector3().subVectors(camera.position, zombie.position).normalize();
      zombie.position.add(dir.multiplyScalar(1.5 * delta));
      if (zombie.position.distanceTo(camera.position) < 1.5) {
        health -= 10 * delta;
        if (health <= 0) {
          alert("Game Over! Final Score: " + score);
          location.reload();
        }
      }
    });

    hud.innerHTML = `Health: ${Math.floor(health)}<br>Score: ${score}`;
    renderer.render(scene, camera);
  }
</script>
</body>
</html>
